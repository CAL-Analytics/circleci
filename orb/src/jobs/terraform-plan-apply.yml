description: >
  This job performs a terraform plan and apply, outputing a pretty plan html file as a viewable artifact.
  It can also check to ensure only a specific set of files were changed before continuing with the pipeline.

executor: default

resource_class: small

parameters:
  tf_env:
    type: string
    description: "This is the middle part of the properties file. i.e. dev, mgmt, pci.prod"
  poetry_path:
    type: string
    default: ""
    description: "Path to poetry toml/lock file. Defaults to None, meaning it lives in the terraform root."
  poetry_install_cmd:
    type: string
    default: ""
    description: "Poetry install command. Defaults to: poetry install"
  trigger_files:
    type: string
    default: ""
    description: "(Optional). Regex path for changes. Wrap in quotes and use a space as delimeter to add multiple paths or files. Examples: ^terraform/.* or app/file.xml or some/file/hello.*.yml"
  slack_thread_id:
    type: string
    default: "thready"
    description: "The Slack thread id for notifications."
  jira_environment:
    type: string
    default: "terraform-plan-apply"
    description: "Jira environment to notify. development, staging, production"
  jira_environment_type:
    type: enum
    enum: ["development", "testing", "staging", "production", "unmapped"]
    default: "development"
    description: "Jira environment type to notify. development, staging, production"
  jira_job_type:
    type: enum
    enum: ["build", "deployment"]
    default: "build"
    description: "Jira job type to notify. build, deployment"
  jira_service_id:
    type: string
    default: "11600"
    description: "Jira service id to notify. 11600 for pt-terrain-elevation"
  jira_pipeline_id:
    type: string
    default: "terraform-plan-apply"
    description: "CircleCI pipeline id. What to name the pipeline in Jira."
  jira_pipeline_number:
    type: integer
    default: 0
    description: "CircleCI pipeline number."    

steps:
  - checkout
  - when:
      condition: << parameters.trigger_files >>
      steps:
        - git-changes:
            trigger_files: << parameters.trigger_files >>
  - terraform-plan:
      tf_env: << parameters.tf_env >>
      poetry_path: << parameters.poetry_path >>
      poetry_install_cmd: << parameters.poetry_install_cmd >>
  - terraform-apply:
      tf_env: << parameters.tf_env >>
      poetry_path: << parameters.poetry_path >>
      poetry_install_cmd: << parameters.poetry_install_cmd >>
  - when:
      condition:
        not: 
          equal: [ 0, << parameters.jira_pipeline_number >> ]
      steps:
        - jira/notify:
            environment: << parameters.jira_environment >>
            environment_type: << parameters.jira_environment_type >>
            job_type: << parameters.jira_job_type >>
            service_id: "<< parameters.jira_service_id >>"
            pipeline_id: "<< parameters.jira_pipeline_id >>"
            pipeline_number: << parameters.jira_pipeline_number >>
  # - slack-notify:
  #     event: fail
  #     custom_message: "Failed :fire:"
  #     slack_thread_id: << parameters.slack_thread_id >>
  # - slack-notify:
  #     event: pass
  #     custom_message: "Success :champagne:"
  #     slack_thread_id: << parameters.slack_thread_id >>


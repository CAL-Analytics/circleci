description: >
  This job deploys a new task definition to an existing ECS Cluster/Service.

executor: default

resource_class: small

parameters:
  app_name:
    type: string
    description: "App name, which doubles as repository name. i.e. unfurly/redirector"
  env_name:
    type: string
    description: "Environment name. i.e. dev"
  cluster_arn:
    type: string
    description: "ECS Cluster ARN"
  service_arn:
    type: string
    description: "ECS Service ARN"
  slack_thread_id:
    type: string
    default: "thready"
    description: "The Slack thread id for notifications."
  jira_environment:
    type: string
    default: "ecs-deploy"
    description: "Jira environment to notify. development, staging, production"
  jira_environment_type:
    type: enum
    enum: ["development", "testing", "staging", "production", "unmapped"]
    default: "development"
    description: "Jira environment type to notify. development, staging, production"
  jira_job_type:
    type: enum
    enum: ["build", "deployment"]
    default: "build"
    description: "Jira job type to notify. build, deployment"
  jira_service_id:
    type: string
    default: "11600"
    description: "Jira service id to notify. 11600 for pt-terrain-elevation"
  jira_pipeline_id:
    type: string
    default: "ecs-deploy"
    description: "CircleCI pipeline id. What to name the pipeline in Jira."
  jira_pipeline_number:
    type: integer
    default: 0
    description: "CircleCI pipeline number."
    
steps:
  - ecs-deploy:
      app_name: << parameters.app_name >>
      env_name: << parameters.env_name >>
      cluster_arn: << parameters.cluster_arn >>
      service_arn: << parameters.service_arn >>
  - git-tag:
      tag: deploy/<< parameters.env_name >>
      delete_tag: deploy/<< parameters.env_name >>_rc
      run_checkout: false
      run_set_up_cicd_env: false
  - when:
      condition:
        not: 
          equal: [ 0, << parameters.jira_pipeline_number >> ]
      steps:
        - jira/notify:
            environment: << parameters.jira_environment >>
            environment_type: << parameters.jira_environment_type >>
            job_type: << parameters.jira_job_type >>
            service_id: "<< parameters.jira_service_id >>"
            pipeline_id: "<< parameters.jira_pipeline_id >>"
            pipeline_number: << parameters.jira_pipeline_number >>

  # - slack-notify:
  #     event: fail
  #     custom_message: "Failed :fire:"
  #     slack_thread_id: << parameters.slack_thread_id >>



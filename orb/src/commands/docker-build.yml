description: >
  This command runs a docker build.

parameters:
  app_name:
    type: string
    description: "Application name as defined in CDK stack properties file."
  env_name:
    type: string
    default: "dev"
    description: "Environment name to deploy. We use this as part of our container Tag. If this is part of a CDK deployed app, make this the same as your properties.ENVNAME.json"
  dockerfile_path:
    type: string
    default: ""
    description: "Path to dockerfile from root of repo. Defaults to root of checked out repo."
  dockerfile_name:
    type: string
    default: "Dockerfile"
    description: "Docker file name. Defaults to Dockerfile."
  docker_platform:
    type: string
    default: ""
    description: "Platform of container. Defaults to executor_tag's platform."
  docker_build_args:
    type: string
    default: ""
    description: "(Optional). Comma separated list of build args to inject into the docker build. Example: PLUM_VERSION=6.0.0,BUILD_VERSION=24.05.07.33.3abcde"
  docker_build_extra_options:
    type: string
    default: ""
    description: "(Optional). Extra options to pass to the docker build command. Example: --ssh default"
  docker_build_env_append:
    type: string
    default: ""
    description: "(Optional). Environment variables to set before running the docker build command. Example: DOCKER_BUILDKIT=1"
  docker_build_ssh:
    type: string
    default: ""
    description: "(Optional). Enable SSH agent setup and --ssh default for docker build. Requires SSH keys to be available."

steps:
  - set-up-cicd-env
  - run:
      environment:
        APP_NAME: << parameters.app_name >>
        ENV_NAME: << parameters.env_name >>
        DOCKERFILE_PATH: << parameters.dockerfile_path >>
        DOCKERFILE_NAME: << parameters.dockerfile_name >>
        DOCKER_PLATFORM: << parameters.docker_platform >>
        DOCKER_BUILD_ARGS: << parameters.docker_build_args >>
        DOCKER_BUILD_EXTRA_OPTIONS: << parameters.docker_build_extra_options >>
        DOCKER_BUILD_ENV_APPEND: << parameters.docker_build_env_append >>
        DOCKER_BUILD_SSH: << parameters.docker_build_ssh >>
      name: Docker Build
      # shell: /bin/bash
      command: docker_build.py